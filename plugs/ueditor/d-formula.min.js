/*! dayeasy.static version:1.1.1 2014-11-07 17:15:03 */
UE.registerUI("kityformula",function(a,b){var c=new UE.ui.Dialog({iframeUrl:a.options.UEDITOR_HOME_URL+"third-party/kityformula-plugin/kityFormulaDialog.html",editor:a,name:b,title:"插入公式",cssRules:"width:783px; height: 386px;",buttons:[{className:"edui-okbutton",label:"确定",onclick:function(){c.close(!0)}},{className:"edui-cancelbutton",label:"取消",onclick:function(){c.close(!1)}}]});a.ready(function(){UE.utils.cssRule("kfformula","img.kfformula{vertical-align: middle;}",a.document)});var d=a.options.UEDITOR_HOME_URL+"third-party/kityformula-plugin/kf-icon.png",e=document.createElement("a");e.href=d,d=e.href;var f=new UE.ui.Button({name:"插入",title:"插入公式",cssRules:'background: url("'+d+'") !important',onclick:function(){c.render(),c.open()}});return a.addListener("selectionchange",function(){var c=a.queryCommandState(b);-1==c?(f.setDisabled(!0),f.setChecked(!1)):(f.setDisabled(!1),f.setChecked(c))}),f}),UE.Editor.prototype.getKfContent=function(a){function b(){g>=i.length&&(ue.sync(),a(c.getContent()))}var c=this,d=c.getActionUrl(c.getOpt("scrawlActionName")),e=UE.utils.serializeParam(c.queryCommandValue("serverparam"))||"",f=UE.utils.formatUrl(d+(-1==d.indexOf("?")?"?":"&")+e),g=0,h=c.body.getElementsByTagName("img"),i=[];UE.utils.each(h,function(a){var b=a.getAttribute("src").match(/^[^;]+/)[0];"data:image/png"===b&&i.push(a)}),0==i.length?b():UE.utils.each(i,function(a){var d={};d[c.getOpt("scrawlFieldName")]=a.getAttribute("src").replace(/^[^,]+,/,""),d.onsuccess=function(d){var e=UE.utils.str2json(d.responseText),f=c.options.scrawlUrlPrefix+e.url;a.setAttribute("src",f),a.setAttribute("_src",f),g++,b()},d.onerror=function(a){console.error(a),g++,b()},UE.ajax.request(f,d)})},UE.plugins.defaultfilter=function(){var a=this;a.setOpt({allowDivTransToP:!0,disabledTableInTable:!0,rgb2Hex:!0}),a.addInputRule(function(b){function c(a){for(;a&&"element"==a.type;){if("td"==a.tagName)return!0;a=a.parentNode}return!1}var d,e=this.options.allowDivTransToP;b.traversal(function(b){if("element"==b.type){if(!UE.dom.dtd.$cdata[b.tagName]&&a.options.autoClearEmptyNode&&UE.dom.dtd.$inline[b.tagName]&&!UE.dom.dtd.$empty[b.tagName]&&(!b.attrs||UE.utils.isEmptyObject(b.attrs)))return void(b.firstChild()?"span"!=b.tagName||b.attrs&&!UE.utils.isEmptyObject(b.attrs)||b.parentNode.removeChild(b,!0):b.parentNode.removeChild(b));switch(b.tagName){case"style":case"script":b.setAttr({cdata_tag:b.tagName,cdata_data:b.innerHTML()||"",_ue_custom_node_:"true"}),b.tagName="div",b.innerHTML("");break;case"a":(d=b.getAttr("href"))&&b.setAttr("_href",d);break;case"img":b.setAttr("_src",b.getAttr("src"));break;case"span":UE.browser.webkit&&(d=b.getStyle("white-space"))&&/nowrap|normal/.test(d)&&(b.setStyle("white-space",""),a.options.autoClearEmptyNode&&UE.utils.isEmptyObject(b.attrs)&&b.parentNode.removeChild(b,!0)),d=b.getAttr("id"),d&&/^_baidu_bookmark_/i.test(d)&&b.parentNode.removeChild(b);break;case"p":(d=b.getAttr("align"))&&(b.setAttr("align"),b.setStyle("text-align",d)),UE.utils.each(b.children,function(a){if("element"==a.type&&"p"==a.tagName){var c=a.nextSibling();b.parentNode.insertAfter(a,b);for(var d=a;c;){var e=c.nextSibling();b.parentNode.insertAfter(c,d),d=c,c=e}return!1}}),b.firstChild()||b.innerHTML(UE.browser.ie?"&nbsp;":"<br/>");break;case"div":if(b.getAttr("cdata_tag"))break;if(d=b.getAttr("class"),d&&/^line number\d+/.test(d))break;if(!e)break;for(var f,g=UE.uNode.createElement("p");f=b.firstChild();)"text"!=f.type&&UE.dom.UE.dom.dtd.$block[f.tagName]?g.firstChild()?(b.parentNode.insertBefore(g,b),g=UE.uNode.createElement("p")):b.parentNode.insertBefore(f,b):g.appendChild(f);g.firstChild()&&b.parentNode.insertBefore(g,b),b.parentNode.removeChild(b);break;case"dl":b.tagName="ul";break;case"dt":case"dd":b.tagName="li";break;case"li":var h=b.getAttr("class");h&&/list\-/.test(h)||b.setAttr();var i=b.getNodesByTagName("ol ul");UE.utils.each(i,function(a){b.parentNode.insertAfter(a,b)});break;case"td":case"th":case"caption":b.children&&b.children.length||b.appendChild(UE.browser.ie11below?UE.uNode.createText(" "):UE.uNode.createElement("br"));break;case"table":a.options.disabledTableInTable&&c(b)&&(b.parentNode.insertBefore(UE.uNode.createText(b.innerText()),b),b.parentNode.removeChild(b))}}})}),a.addOutputRule(function(b){var c;b.traversal(function(b){if("element"==b.type){if(a.options.autoClearEmptyNode&&UE.dom.dtd.$inline[b.tagName]&&!UE.dom.dtd.$empty[b.tagName]&&(!b.attrs||UE.utils.isEmptyObject(b.attrs)))return void(b.firstChild()?"span"!=b.tagName||b.attrs&&!UE.utils.isEmptyObject(b.attrs)||b.parentNode.removeChild(b,!0):b.parentNode.removeChild(b));switch(b.tagName){case"div":(c=b.getAttr("cdata_tag"))&&(b.tagName=c,b.appendChild(UE.uNode.createText(b.getAttr("cdata_data"))),b.setAttr({cdata_tag:"",cdata_data:"",_ue_custom_node_:""}));break;case"a":(c=b.getAttr("_href"))&&b.setAttr({href:UE.utils.html(c),_href:""});break;case"span":if(c=b.getAttr("id"),c&&/^_baidu_bookmark_/i.test(c)&&b.parentNode.removeChild(b),a.getOpt("rgb2Hex")){var d=b.getAttr("style");d&&b.setAttr("style",d.replace(/rgba?\(([\d,\s]+)\)/g,function(a,b){var c=b.split(",");if(c.length>3)return"";b="#";for(var d,e=0;d=c[e++];)d=parseInt(d.replace(/[^\d]/gi,""),10).toString(16),b+=1==d.length?"0"+d:d;return b.toUpperCase()}))}break;case"img":(c=b.getAttr("_src"))&&b.setAttr({src:b.getAttr("_src"),_src:""})}}})})};